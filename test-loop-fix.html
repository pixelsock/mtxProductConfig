<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loop Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-line;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîß Loop Fix Test</h1>
    <p>Testing the infinite loop fix for product configuration updates.</p>

    <div id="status" class="status warning">
        ‚è≥ Initializing test...
    </div>

    <h3>Console Output:</h3>
    <div id="console-log" class="log"></div>

    <script type="module">
        import { useConfiguratorStore } from './src/store/store.js';

        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('console-log');
        let logMessages = [];

        // Capture console messages
        const originalLog = console.log;
        const originalError = console.error;

        function addLog(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${type}: ${message}`;
            logMessages.push(logMessage);
            logEl.textContent = logMessages.slice(-50).join('\n'); // Keep last 50 messages
            logEl.scrollTop = logEl.scrollHeight;
        }

        console.log = (...args) => {
            originalLog(...args);
            addLog('LOG', args.join(' '));
        };

        console.error = (...args) => {
            originalError(...args);
            addLog('ERROR', args.join(' '));
        };

        try {
            statusEl.textContent = 'üîÑ Initializing store...';
            statusEl.className = 'status warning';

            // Test the store initialization
            const store = useConfiguratorStore.getState();
            console.log('Store initialized successfully');

            // Test product line loading
            statusEl.textContent = 'üì¶ Loading product line...';
            const { loadProductLineOptions, setCurrentProductLine } = useConfiguratorStore.getState();

            // Simulate selecting a product line (using a mock)
            const mockProductLine = {
                id: 19,
                name: 'Deco',
                sku_code: 'D',
                active: true
            };

            console.log('Setting product line to:', mockProductLine.name);
            setCurrentProductLine(mockProductLine);

            // Watch for loops by counting consecutive calls
            let productUpdateCount = 0;
            let lastProductId = null;

            const unsubscribe = useConfiguratorStore.subscribe((state) => {
                if (state.currentProduct) {
                    if (state.currentProduct.id === lastProductId) {
                        productUpdateCount++;
                        if (productUpdateCount > 3) {
                            console.error(`‚ö†Ô∏è Possible loop detected: Product ${state.currentProduct.id} updated ${productUpdateCount} times`);
                            statusEl.textContent = '‚ùå Loop detected!';
                            statusEl.className = 'status error';
                            return;
                        }
                    } else {
                        productUpdateCount = 1;
                        lastProductId = state.currentProduct.id;
                    }

                    console.log(`Product updated: ${state.currentProduct.name} (${state.currentProduct.id}) - Update #${productUpdateCount}`);
                }
            });

            // Wait and check for stability
            setTimeout(() => {
                if (productUpdateCount <= 3) {
                    statusEl.textContent = '‚úÖ Loop fix appears to be working!';
                    statusEl.className = 'status success';
                    console.log(`‚úÖ Test completed. Product updates: ${productUpdateCount}`);
                } else {
                    statusEl.textContent = '‚ùå Loop still occurring';
                    statusEl.className = 'status error';
                }
            }, 5000);

        } catch (error) {
            console.error('Test failed:', error);
            statusEl.textContent = `‚ùå Test failed: ${error.message}`;
            statusEl.className = 'status error';
        }
    </script>
</body>
</html>
