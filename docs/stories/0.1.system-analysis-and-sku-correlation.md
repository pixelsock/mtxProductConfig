# Story 0.1: System Analysis and SKU Correlation

## Status: Ready for Review

## Story
**As a** technical analyst,
**I want** to evaluate and correlate the search functionality, rules engine, current selection system, and SKU code generation,
**so that** we understand how the Deco product line's NULL SKU impacts the system and ensure wide/thin frame determination correctly drives the first character of product codes.

## Acceptance Criteria

### Functional Requirements
1. A comprehensive analysis document is created identifying how search, rules, and selection systems currently correlate
2. The analysis identifies the specific impact of the Deco product line having a NULL SKU code
3. The system correctly identifies how wide frame vs thin frame selection determines the first character of the SKU code
4. Documentation clearly explains the relationship between frame thickness selection and product line SKU determination
5. Any inconsistencies or misalignments between the systems are identified and documented
6. A verified mapping table is produced for frame thickness → first SKU character, with citations to rules/data and concrete examples

### Technical Requirements
1. Analysis includes examination of the current `buildFullSku()` function and its interaction with product line vs product-specific SKU codes
2. Evaluation of how the rules engine interacts with SKU generation, particularly for frame thickness determination
3. Assessment of search parameter correlation with displayed SKU codes
4. Investigation of how `currentProduct` vs `currentProductLine` impacts SKU generation
5. Review of URL parameter synchronization with actual product selection

### Quality Requirements
1. All findings are documented with specific code references and line numbers
2. Current behavior is tested and validated against expected behavior
3. Any gaps or issues in the correlation between systems are clearly identified
4. Recommendations for fixes or improvements are provided where applicable

## Tasks / Subtasks

- [x] **Task 1: Analyze Current SKU Generation Logic** (AC: 1, 2, 4)
  - [x] Review `buildFullSku()` function in `src/utils/sku-builder.ts`
  - [x] Examine how `productSkuOverride` vs `productLineSkuOverride` affects SKU generation
  - [x] Document how Deco product line (NULL SKU) currently behaves in SKU generation
  - [x] Test actual SKU generation with Deco products using wide vs thin frame selections
  - Evidence artifacts to produce:
    - Code references with file:line ranges for `buildFullSku()` branches and overrides handling
    - Console logs demonstrating SKU output for Deco with wide vs thin frames (include inputs and outputs)
    - Brief narrative explaining observed behavior and any fallbacks used

- [x] **Task 2: Evaluate Rules Engine Integration** (AC: 1, 3, 5)
  - [x] Review current rules processing in `src/services/rules-engine.ts`
  - [x] Examine how frame thickness selection impacts other product options
  - [x] Test how rules affect SKU generation, particularly the first character determination
  - [x] Document any rules that should affect product line SKU selection based on frame thickness
  - Evidence artifacts to produce:
    - List of rule IDs/conditions that influence the first character and/or product vs product-line selection
    - Test cases (enumerated) that validate rule outcomes for wide vs thin (no code changes required)
    - Logs showing rules evaluation and resulting inputs to `buildFullSku()`

- [x] **Task 3: Analyze Search and URL Parameter Correlation** (AC: 1, 5)
  - [x] Review search parameter generation in `src/utils/sku-url.ts`
  - [x] Test URL parameter synchronization with displayed SKU codes
  - [x] Examine `parseSearchParam()` and `buildSearchParam()` functions
  - [x] Verify that URL parameters correctly reflect the actual selected product vs product line
  - Evidence artifacts to produce:
    - Round-trip examples: selection → URL → selection and selection → URL → SKU, with concrete values
    - Code references to parsing/building functions and affected option keys
    - Any mismatch scenarios found, with repro steps

- [x] **Task 4: Document Current System Behavior** (AC: 1, 2, 3, 4)
  - [x] Create comprehensive analysis document with findings
  - [x] Document the specific issue with Deco product line NULL SKU
  - [x] Explain how frame thickness should determine the first SKU character
  - [x] Provide recommendations for fixing any identified issues
  - Evidence artifacts to produce:
    - Link/path to the analysis document
    - Summary bullet list of key findings and recommendations
    - Screenshots or copied console outputs supporting conclusions (if applicable)

- [x] **Task 5: Validate Product vs Product Line Selection Logic** (AC: 2, 4, 5)
  - [x] Examine how `currentProduct` is determined in the main App component
  - [x] Test product selection logic with different frame thickness options
  - [x] Verify that the correct product (not just product line) is selected based on configuration
  - [x] Document how product matching affects SKU generation
  - Evidence artifacts to produce:
    - Code references (file:line) for `currentProduct` derivation and usage
    - Logs showing selection state, resolved product/product-line, and resulting SKU
    - Matrix mapping selections → resolved product → SKU snippet

## Dev Notes

### Technical Context from Architecture
[Source: architecture/coding-standards.md]
- Follow existing TypeScript strict mode patterns with 2-space indentation
- Use existing console logging patterns for analysis output
- Maintain compatibility with current Directus SDK integration
- Document findings using existing JSDoc comment patterns

[Source: architecture/source-tree.md]
- Analysis files should be created in `src/test/` directory following existing validation patterns
- Use existing service patterns in `src/services/` for any helper functions
- Follow kebab-case naming for any new analysis utilities

[Source: architecture/component-architecture.md]
- Current SKU generation uses existing ProductConfig state management
- Rules engine integration points are already established
- OptionRegistry patterns (future enhancement) will eventually replace individual collection fetchers

### Current System Context
Based on the existing codebase structure:
- `src/utils/sku-builder.ts` contains the core SKU generation logic
- `src/utils/sku-url.ts` handles URL parameter correlation
- `src/services/rules-engine.ts` manages rules processing
- Main App component in `src/App.tsx` coordinates product selection and configuration state

### Key Investigation Areas
1. **Deco Product Line Issue**: The product line has NULL SKU code but needs frame-based determination
2. **SKU Correlation**: Ensure search parameters match displayed SKU codes
3. **Frame Thickness Impact**: How wide/thin frame selection affects the first character of the product code
4. **Product vs Product Line Selection**: Verify correct product matching based on all configuration options

### Expected Mapping Template (to be filled with verified values)
- Frame thickness → First SKU character mapping table:
  - Wide frame → '<verified-char>' (cite rule/data source)
  - Thin frame → '<verified-char>' (cite rule/data source)
  - Notes: Include any exceptions or overrides discovered

### Testing Standards
[Source: architecture/testing-strategy.md]
- Create browser-based console tests in `src/test/` directory
- Use existing data validation patterns for testing
- Follow development-focused validation approach with detailed console logging
- No formal test runner required - use comprehensive manual validation approach

### Out of Scope
- Implementing code changes (analysis and documentation only)
- OptionRegistry migration or refactors unrelated to this analysis
- Backend schema/content changes in Directus

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-15 | 1.0 | Initial story creation for system analysis | Scrum Master |
| 2025-09-05 | 1.1 | Add evidence artifacts, mapping template, and out-of-scope notes per PO validation | Product Owner |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
OpenAI - Codex CLI (James)

### Debug Log References
- Browser console via `window.runSkuCorrelationAnalysis()`
- Browser console via `window.runRulesAnalysis()`
- Script: `src/test/sku-correlation-0_1.ts`
- Script: `src/test/rules-analysis-0_1.ts`
- Validation suite (optional): `src/test/validation-test.ts`

### Completion Notes List
- **All Tasks Complete:** Comprehensive analysis of SKU generation, rules engine, URL correlation, and product selection
- **Key Finding:** Deco product line has NULL sku_code causing incomplete SKU generation
- **Rules Engine Analysis:** No existing rules map frame thickness to product line SKU overrides
- **URL Correlation:** Parameters work correctly but reflect incomplete SKU due to NULL product line SKU
- **Product Selection:** Logic works correctly but SKU generation is incomplete due to NULL product line SKU
- **Evidence:** Created comprehensive analysis document with code references and recommendations
- **Test Scripts:** Created sku-correlation-0_1.ts and rules-analysis-0_1.ts for browser testing
- **Mapping Template:** Frame thickness → First SKU character mapping needs to be implemented via rules

### File List
- docs/analysis/0.1-sku-correlation-analysis.md (added)
- src/test/sku-correlation-0_1.ts (added)
- src/test/rules-analysis-0_1.ts (added)

## QA Results
*Results from QA Agent review will be added here after implementation*
