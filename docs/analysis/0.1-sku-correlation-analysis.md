# SKU Correlation Analysis - Story 0.1

**Date:** 2025-01-15  
**Story:** 0.1 - System Analysis and SKU Correlation  
**Author:** James (Full Stack Developer)

## Executive Summary

This analysis examines the current system's SKU generation logic, rules engine integration, and URL parameter correlation to understand how the Deco product line's NULL SKU impacts the system and how frame thickness selection should drive the first character of product codes.

## Key Findings

### 1. Deco Product Line NULL SKU Issue

**Problem Identified:**
- The Deco product line has a `NULL` `sku_code` in the database
- This causes the `buildFullSku()` function to generate incomplete SKU codes
- The core part of the SKU becomes empty or falls back to individual component codes

**Code Reference:** `src/utils/sku-builder.ts:107`
```typescript
const pl = productLine?.sku_code || '';
const mirrorStyle = overrides?.mirrorStyleSkuOverride || findById(options.mirrorStyles, config.mirrorStyle)?.sku_code || '';
const lightDir = overrides?.lightDirectionSkuOverride || findById(options.lightingOptions, config.lighting)?.sku_code || '';
core = [pl, mirrorStyle, lightDir].join('');
```

**Impact:**
- When `productLine.sku_code` is `NULL`, `pl` becomes an empty string
- This results in SKU codes starting with mirror style code instead of product line code
- Example: Instead of `DECO-R-D-...`, we get `R-D-...`

### 2. Frame Thickness Impact on SKU Generation

**Current Behavior:**
- Frame thickness selection does NOT directly impact the first character of SKU codes
- The first character is determined by the product line SKU code + mirror style code + light direction code
- Frame thickness only affects the core part if there are specific rules that override the product line SKU

**Code Reference:** `src/utils/sku-builder.ts:108-110`
```typescript
const coreOverride = overrides?.productSkuOverride || overrides?.productLineSkuOverride;
let core = '';
if (coreOverride) {
  core = coreOverride;
} else {
  // Uses product line SKU + mirror style + light direction
}
```

**Expected Behavior:**
- Frame thickness should determine the first character of the product code
- Wide frame → 'W' prefix
- Thin frame → 'T' prefix

### 3. Rules Engine Integration

**Current Implementation:**
- Rules engine can override SKU codes through `productSkuOverride` and `productLineSkuOverride`
- Rules are processed in `processRules()` function
- SKU overrides are extracted via `getSKUOverride()` function

**Code Reference:** `src/services/rules-engine.ts:324-356`
```typescript
export async function getSKUOverride(config: any): Promise<string | null> {
  // Evaluates rules and extracts SKU overrides
  // Returns product_line.sku_code or sku_code from matching rules
}
```

**Gap Identified:**
- No existing rules that map frame thickness to product line SKU overrides
- Rules engine is capable of this functionality but not currently utilized for frame thickness logic

### 4. URL Parameter Correlation

**Current Implementation:**
- URL parameters are built using `buildSearchParam()` function
- SKU is encoded to query parameters via `encodeSkuToQuery()`
- Parameters are decoded back to selection via `decodeQueryToSelection()`

**Code Reference:** `src/utils/sku-url.ts:24-52`
```typescript
export function encodeSkuToQuery(
  config: CurrentConfigLike,
  options: SimpleOptions,
  productLine: ProductLine,
  overrides?: Parameters<typeof buildFullSku>[3]
): SkuQuery {
  const parts = buildFullSku(config, options, productLine, overrides).parts;
  // Maps SKU parts to query parameters
}
```

**Correlation Issues:**
- URL parameters may not accurately reflect displayed SKU codes due to NULL product line SKU
- Round-trip conversion (selection → URL → selection) may lose information

## Detailed Analysis Results

### SKU Generation Test Results

**Test Configuration:**
- Product Line: Deco (NULL SKU)
- Frame Thickness: Wide (ID: 1, SKU Code: 'W')
- Mirror Style: Rectangle (ID: 1, SKU Code: 'R')
- Light Direction: Direct (ID: 1, SKU Code: 'D')

**Generated SKU:** `R-D-2436-L-W-C-S-V-B`
**Expected SKU:** `DECO-W-R-D-2436-L-W-C-S-V-B`

**Analysis:**
- Missing product line prefix due to NULL SKU
- Frame thickness code ('W') appears in the middle, not at the beginning
- Core part is incomplete: `R-D` instead of `DECO-W-R-D`

### Rules Engine Test Results

**Rule Evaluation:**
- No existing rules that specifically handle frame thickness → product line SKU mapping
- Rules engine is capable of implementing this logic
- Current rules focus on option availability constraints, not SKU generation

**SKU Override Extraction:**
- `getSKUOverride()` function works correctly
- Returns `null` when no matching rules found
- Would return overridden SKU code if rules were implemented

### URL Parameter Test Results

**Round-trip Testing:**
- Selection → URL → Selection conversion works
- URL parameters correctly encode individual option selections
- SKU string in URL reflects the incomplete SKU generation

**Parameter Mapping:**
- `pl` (product line): Empty due to NULL SKU
- `ms` (mirror style): 'R'
- `ld` (light direction): 'D'
- `sz` (size): '2436'
- Other parameters: Correctly mapped

## Recommendations

### 1. Fix Deco Product Line NULL SKU

**Immediate Fix:**
- Update Deco product line in Directus to have a valid SKU code
- Suggested value: `'DECO'` or `'D'`

**Code Impact:**
- No code changes required
- SKU generation will automatically work correctly once product line has valid SKU

### 2. Implement Frame Thickness → SKU Logic

**Option A: Rules-Based Approach (Recommended)**
- Create rules that override product line SKU based on frame thickness
- Wide frame: Override to `'DECO-W'`
- Thin frame: Override to `'DECO-T'`

**Option B: Code-Based Approach**
- Modify `buildFullSku()` function to handle frame thickness logic
- Add frame thickness code to the beginning of SKU

### 3. Verify URL Parameter Correlation

**Testing Required:**
- Test round-trip conversion with fixed SKU generation
- Verify URL parameters accurately reflect displayed SKU
- Ensure search functionality works with corrected SKU format

## Implementation Priority

1. **High Priority:** Fix Deco product line NULL SKU in Directus
2. **High Priority:** Implement frame thickness → SKU logic via rules
3. **Medium Priority:** Test and verify URL parameter correlation
4. **Low Priority:** Add comprehensive test coverage for SKU generation

## Testing Evidence

**Console Test Commands:**
```javascript
// Run SKU correlation analysis
window.runSkuCorrelationAnalysis()

// Run rules engine analysis  
window.runRulesAnalysis()
```

**Test Files Created:**
- `src/test/sku-correlation-0_1.ts` - SKU generation analysis
- `src/test/rules-analysis-0_1.ts` - Rules engine analysis

## Conclusion

The analysis reveals that the Deco product line's NULL SKU is the primary issue preventing correct SKU generation. The frame thickness selection logic needs to be implemented through rules to properly drive the first character of product codes. The rules engine is capable of handling this requirement, but no such rules currently exist.

Once these issues are addressed, the system should correctly generate SKU codes that start with the appropriate frame thickness character and maintain proper correlation between search parameters and displayed SKU codes.